---
loader: taskgraph.loader.transform:loader

transforms:
  - firefox_tv_taskgraph.build:transforms
  - taskgraph.transforms.task:transforms

jobs:
  pr:
    label: Firefox for Amazon's Fire TV - Build - Pull Request
    description: ''
    worker-type: b-android
    run-on-tasks-for: [github-pull-request]
    scopes:
      - secrets:get:project/mobile/firefox-tv/tokens
    worker:
      script: |
        git fetch {repo_url} {branch}
        git config advice.detachedHead false
        git checkout {commit}
        yes | sdkmanager --licenses
        ./gradlew -PisPullRequest clean assembleSystem assembleAndroidTest lint checkstyle ktlint pmd detekt test
        ./gradlew -Pcoverage jacocoSystemDebugTestReport
        ./tools/taskcluster/upload-coverage-report.sh
        ./tools/taskcluster/download-firebase-sdk.sh
        ./tools/taskcluster/google-firebase-testlab-login.sh
        ./tools/taskcluster/execute-firebase-test.sh system/debug app-system-debug model=sailfish,version=25,orientation=landscape
  master:
    label: Firefox for Amazon's Fire TV - Build - Master
    description: ''
    worker-type: b-android
    run-on-tasks-for: [github-push]
    scopes:
      - secrets:get:project/mobile/firefox-tv/tokens
    worker:
      script: |
        git fetch {repo_url}
        git config advice.detachedHead false
        git checkout {commit}
        yes | sdkmanager --licenses
        ./gradlew -PisPullRequest clean assembleSystem assembleAndroidTest lint checkstyle ktlint pmd detekt test
        python ./tools/taskcluster/get-bitbar-token.py
        python ./tools/taskcluster/execute-bitbar-test.py system/debug app-system-debug
  release:
    label: Firefox for Fire TV - Release build
    description: ''
    worker-type: b-android
    run-on-tasks-for: [github-release]
    scopes:
      - secrets:get:project/mobile/firefox-tv/tokens
    worker:
      artifacts:
        - name: public/build/target.apk
          path: /opt/firefox-tv/app/build/outputs/apk/system/release/app-system-release-unsigned.apk
          type: file
      script: |
        git fetch {repo_url} --tags
        git config advice.detachedHead false
        git checkout {tag}
        yes | sdkmanager --licenses
        python tools/taskcluster/get-sentry-token.py
        python tools/taskcluster/get-pocket-token.py
        ./gradlew --no-daemon clean test assembleSystemRelease

